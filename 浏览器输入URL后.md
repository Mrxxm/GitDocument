## 浏览器输入URL后

![](https://img3.doubanio.com/view/photo/l/public/p2535456203.jpg)

从输入URL到浏览器显示页面，就是取别人主机中一个页面的过程。我们告诉浏览器要取谁的（域名/IP）哪个页面（资源路径），然后浏览器帮我们在茫茫主机群中找到这台主机（网络传输），主机收到后，准备好内容（动态页面）再返回给我们。

## 浏览器

**URL解析：** 当输入完整URL，并输入回车后，浏览器开始解析这个URL，包括协议、网络地址、请求资源、参数等。

URL(Uniform Resource Locator)是“统一资源定位符”的英文缩写，用于描述一个网络上的资源, 基本格式如下:

```
scheme://host[:port#]/path/.../[?query-string][#anchor]
scheme         指定底层使用的协议(例如：http, https, ftp)
host           HTTP服务器的IP地址或者域名
port#          HTTP服务器的默认端口是80，这种情况下端口号可以省略。如果使用了别的端口，必须指明，例如 http://www.cnblogs.com:8080/
path           访问资源的路径
query-string   发送给http服务器的数据
anchor         锚
```

## 网络传输

进行网络传输的一个前提是我们要知道目标主机的IP（这样才能知道把请求交给哪个网段）和目标主机的MAC地址（这样才能知道把请求交给哪台主机）。

## DNS解析

因为我们输入的是域名，所以先要通过域名获取IP，也就是DNS解析。

以`www.qq.com`的解析为例，来说明下详细过程：

1. 浏览器得到www.qq.com域名后，会使用操作系统的系统调用函数，检查本地的hosts文件中是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。

2. 如果hosts里没有这个域名的映射，则查找本地DNS解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。

3. 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析。

4. 如果hosts与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/IP参数中设置（网络设置）的首选DNS服务器（也叫本地DNS服务器）。该服务器收到查询请求后，如果要查询的域名在本地配置区域资源中（也就是由本地DNS服务器解析），则返回解析结果给客户机，完成域名解析。

5. 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至 “根DNS服务器”，“根DNS服务器”收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找qq.com域服务器，重复上面的动作，进行查询，直至找到www.qq.com主机。

6. 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。


总之就是一个你问本地DNS服务器，本地DNS服务器不知道就帮你问，一直到有结果返回给你的过程，用图片表示是这样的：

![](https://img1.doubanio.com/view/photo/l/public/p2535799417.jpg)

```
所谓递归查询过程就是“查询的递交者”更替, 而迭代查询过程则是“查询的递交者”不变。
本地DNS服务器帮客户端发起请求，是递归方式；本地DNS服务器多次发起请求，是迭代方式。
```

**DNS解析负载均衡:** 有时会有这样的情况，多个解析同一个DNS得到的IP地址不同，这是通过DNS做了负载均衡。为了防止多个请求同时到达同一个服务器，从而导致服务器资源不够用而崩溃，在解析域名时，就把请求分到不同的服务器上（虽然它们的内容是相同的）。

总之，经过DNS后，我们得到了目标主机的IP。

## HTTP请求

**HTTP请求结构**

Request包分为3部分，第一部分叫Request line（请求行）, 第二部分叫Request header（请求头）,第三部分是body（主体）。header和body之间有个空行，请求包的例子所示:

```
GET /domains/example/ HTTP/1.1        //请求行: 请求方法 请求URI HTTP协议/协议版本
Host：www.iana.org                //服务端的主机名
User-Agent：Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.4 (KHTML, like Gecko) Chrome/22.0.1229.94 Safari/537.4            //浏览器信息
Accept：text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8    //客户端能接收的mine
Accept-Encoding：gzip,deflate,sdch        //是否支持流压缩
Accept-Charset：UTF-8,*;q=0.5        //客户端字符编码集
//空行,用于分割请求头和消息体
//消息体,请求资源参数,例如POST传递的参数
```

经过包装后，会形成这样的一个报文：
![](https://img3.doubanio.com/view/photo/l/public/p2535799780.jpg)

## HTTPS请求

因为HTTP的传输不是加密的，所以容易被劫持和篡改。出于这方面的考虑，有些公司会使用HTTPS，也就是增加了一个加密的过程。从网络传输的过程来看就是在HTTP和TCP之间增加了SSL层。

![](https://img1.doubanio.com/view/photo/l/public/p2535799877.jpg)

关于HTTPS的详细解释可以参考[SSL/TLS协议运行机制的概述](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)。

## TCP请求

应用层结束之后，就进入了传输层。传输层协议包括TCP和UDP协议。HTTP请求使用TCP协议。因为已知目标主机的IP，就可以建立连接。TCP连接的建立，也就是俗称的“3次握手”，是由以下步骤完成的：

1. Client 端发送连接请求报文，其中建立连接的标志位 SYN = 1；
2. Server 端收到后，回复确认报文，其中标志位 SYN = 1, ACK = 1，并为这次连接分配资源；
3. Client 端接收到ACK报文后，也会向 Server 端发送 ACK 报文，其中标志位 ACK = 1，并分配资源，这样 TCP 连接就建立好了。

用图表示是这样的：

![](https://img3.doubanio.com/view/photo/l/public/p2535800372.jpg)

TCP报文的格式如下：

![](https://img3.doubanio.com/view/photo/l/public/p2535800386.jpg)

其中，源端口是操作系统给浏览器的这个请求随机分配的一个端口，目的端口一般都是80（HTTP请求的默认端口）。

当数据传输完成后，需要断开TCP连接，TCP连接的断开可能是客户端和服务器中的任意一个。TCP连接的断开需要4个步骤：

1. 假设 Client 端发起中断连接请求，其中标志位FIN = 1，也就是发送FIN报文；
2. Server 端接到 FIN 报文后，向 Client 端发送确认报文，其中标志位ACK = 1，此时，Server 端还可以继续向 Client 端发送数据；
3. 当 Server 端没有数据发送时，向 Client 端发送中断请求报文，FIN = 1；
4. Client 端收到后，返回确认报文 ACK = 1给 Server 端，并等待 2MSL 时间后，断开连接。

用图表示是这样的：

![](https://img3.doubanio.com/view/photo/l/public/p2535800682.jpg)

## 网络层封装

传输层任务完成后，数据就进入了网络层。网络层解决的是如何从源IP到目的IP，也就是路由问题。
IP数据包的结构如下：

![](https://img3.doubanio.com/view/photo/l/public/p2535800764.jpg)

网络中的各个网关设备（路由器）都维护着一张路由表，通过它并根据某个路由协议（OSPF，RIP，BGP等），决定把数据包发送至哪个节点，最终到达目的IP所在的网段。

另外，源地址IP是如何确定的？一般情况下，我们都处在局域网中（使用联通或者电信的宽带，然后多台设备通过路由器接入）。这种网络情况下，我们查询本机IP，基本形式是192.168.x.x，这是c类地址的保留IP地址，是内部IP（可能是通过DHCP随机分配的，也有可能是静态的）。当我们在网上查询本机IP，会发现是另外一个（通常是ISP分配给我们的那个），这个是外部IP，也就是源IP地址。(同一局域网中的多台设备的内部IP不同，通过NAT映射到同一个外部IP不同端口上)。

## 数据链路层

网络层任务完成后，数据就进入了数据链路层。此时我们知道了目标IP，可以将请求发送到目标网段，我们还需要知道目标主机的MAC地址（因为MAC地址才是唯一标识，IP只是逻辑地址，是可以更改的）。所以要求我们通过IP来获取MAC地址，就需要使用ARP协议。

ARP协议有两种使用场景，源IP和目的IP位于同一网段以及位于不同网段（是否处于同一网段需要利用IP+子网掩码来判断）。同一网段只需要源IP主机发送ARP广播，目的IP收到后会回复一条ARP单播即可。源IP和目的IP不在同一网段则需要网关的MAC地址作为中转，多次广播，得到目的IP的MAC地址。

具体过程可参考：<https://github.com/Mrxxm/GitDocument/blob/master/Protocol/ARP.md>

