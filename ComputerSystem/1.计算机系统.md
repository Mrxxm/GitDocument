## 1.计算机系统

![](https://img1.doubanio.com/view/photo/l/public/p2551874919.jpg)

我们通过hello程序的生命周期来开始对系统的学习

#### 信息就是位 + 上下文

文件名：`hello.c`

位：`bit`

字节：`byte`

源程序实际上就是由0和1组成的位序列，8个位为一组，称为字节。

大部分的现代系统都使用ASCII标准来表示文本字符。每个文本的行都是以一个不可见的`\n`来结束的，它所对应的整数值为10。

![](https://img1.doubanio.com/view/photo/l/public/p2551876189.jpg)

`hello.c`表示方法说明了一个基本思想：系统中所有信息都是由一串位表示的。区分不同的数据对象的唯一办法是我们读到这些数据对象时的上下文。

#### 程序被其他程序翻译成不同的格式

在`Unix`系统上，从源程序到目标程序的转化由**编译器驱动程序**完成的。

`hello.c` --  以二进制磁盘文件的形式存放 --> 可执行目标程序/文件

```
unix> gcc -o hello hello.c
```

![](https://img3.doubanio.com/view/photo/l/public/p2551877140.jpg)

编译器驱动程序：GCC编译器-源于GNU项目 

编译系统：预处理器、编译器、汇编器和链接器

汇编语言：它为不同高级语言的不同编译器提供了通用的输出语言，如**C编译器**和**Fortran编译器**输出文件用的都是一样的汇编语言

* 预处理阶段：将源程序以`#`开头的命令，修改源程序。将`stdio.h`，插入到程序文本中。

* 编译阶段：将源程序转化成汇编语言程序。

* 汇编阶段：将指令打包成**可重定位目标程序**的格式，以二进制的格式保存在`hello.o`中。

* 链接阶段：对于调用`printf`函数，它是编译器提供标准C库的一个函数。具体存在于一个名为`printf.o`的单独的预编译好的目标文件中。链接器就是将其引入到hello文件中。

#### 了解编译系统如何工作是大有益处的

* 优化程序性能。如：`switch`语句是否比`if-then-else`语句更高效？

* 理解链接时出现的错误。 如：链接器无法解析一个引用，这是什么意思？

* 避免安全漏洞。理解数据和控制信息存储在程序栈上的方式会引起的后果。

#### 处理器读并解释存储在存储器中的指令

Shell：命令行解释器

```
unix> ./hello
hello, world
unix>
```

`Shell`工作过程：输入一个命令行。如果该命令行的第一个单词不是一个内置的`shell`命令，那么会假设这是一个可执行文件的名字，它将加载并运行这个文件。

#### 系统的硬件组成

`Intel Pentium` 系统模型

![](https://img3.doubanio.com/view/photo/l/public/p2551880984.jpg)

字：`word`

1.总线：贯穿整个系统的一组电子管道。传送定长的字节块，简称**字**。字中的字节数即**字长**是一个基本的系统参数。各个系统各不相同，有的4个字节(32位)，有的8个字节(64位)。**这里假定4个字节**，并且总线每次只传送一个字。

2.`I/O设备`：示例中包括4个输入输出设备，用户输入的有鼠标和键盘，用户输出的有显示器，以及长期存储数据和程序的磁盘。每个`I/O设备`都通过一个控制器或适配器与`I/O总线`相连。控制器或适配器之间的区别在于封装方式。控制器置于`I/O设备`本身或置于系统主板上的芯片组，适配器则是一块插在主板插槽上的卡。

3.主存：由一组动态随机存取存储器(DRAM)芯片组成的。从逻辑上讲，存储器是一个线性的字节数组，每个字节都有其唯一地址(即数组索引)，这些地址从零开始。一般来讲，组成程序的每条机器指令都是由不同数量的字节构成。

4.处理器：处理器的核心是一个字长的存储设备(或寄存器)，称为**程序计数器**(PC)。在任何时刻，程序计数器都指向主存中的某条机器语言指令(即含有该条指令的地址)。

4.1.系统从通电到断电，不断执行PC指向的指令，并更新使其指向下一个指令。执行按照**指令执行模型**，而指令执行模型由**指令集结构**决定的。模型中，指令按照严格的顺序执行，而执行一条指令包含执行一系列的步骤。以上过程总结：处理器读取PC指向的指令，解释指令中的位，执行该指令的简单操作，然后更新PC，使其指向下一条指令。问题：**而下一条指令并不一定与存储器中刚刚执行的指令相邻**。

算术/逻辑单元：`ALU` 计算新的数据和地址值

寄存器文件：`register file` 是一个小的存储设备，由一些1字长的寄存器组成，每个寄存器都有唯一的名字

4.2.以上为处理器简单操作，以下列举一些简单操作例子：

* 加载：把一个字节或者一个字从主存复制到寄存器，以覆盖寄存器原有内容

* 存储：把一个字节或者一个字从寄存器复制到主存的某个位置，以覆盖这个位置上的原有内容

* 操作：把两个寄存器中的内容复制到ALU，ALU对这两个字做算术操作，并将结果存放到一个寄存器中，以覆盖该寄存器中的原有内容

* 跳转：从指令本身中抽取一个字，并将这个字复制到PC中，以覆盖PC中的原有值

4.3.处理器对指令集结构的简单实现，但实际现代处理器做了复杂的机制来加速程序的执行。因此可以这样区分处理器的指令集结构和微体系结构：

* 指令集结构：描述的是每条机器代码指令的效果

* 微体系结构：描述的是处理器实际上是如何实现的

#### 运行hello程序

hello程序运行的整体描述

![](https://img3.doubanio.com/view/photo/l/public/p2551885594.jpg)

当我们在键盘上输入字符串`./hello`后，shell将字符逐一读入寄存器，再把它存放到存储器中，如图`1-5`所示

![](https://img3.doubanio.com/view/photo/l/public/p2551886196.jpg)

利用**直接存储器存取**(DMA)的技术，数据可以不通过处理器而直接从磁盘到达内存。这个步骤如图`1-6`所示。

一旦目标文件hello中的代码和数据被加载到主存，处理器就开始执行hello程序的main程序中的机器语言指令。这些指令将`hello, world\n`字符串中的字节从主存复制到寄存器文件，再从寄存器文件中复制到显示设备，最终显示在屏幕上，这个步骤如图`1-7`所示。


#### 高速缓存至关重要

以上示例揭示了一个重要的问题，系统花费大量时间来转移信息存放的位置，这些复制所消耗的时间就是开销。所以我们需要降低开销。

如：磁盘比主存大1000倍，但处理器从磁盘读取一个字的时间比从主存中读取大1000万倍

相似的：主存比寄存器文件大，但处理器从寄存器文件读取数据比从主存中快100倍。随着半导体技术的进步，这种处理器与主存之间的差距还在增大。

针对处理器和主存之间的差异，出现了**高速缓存存储器**简称高速缓存，作为暂时的集结区域，用来存放处理器近期可能会需要的信息。如图`1-8`所示。

![](https://img3.doubanio.com/view/photo/l/public/p2551888023.jpg)

L1高速缓存：位于处理器芯片上，容量数万字节，访问速度几乎和访问寄存器文件一样快

L2高速缓存：通过一条特殊总线连接到处理器，容量为数十万到百万字节，进程访问L2比访问L1慢5倍，比主存快5~10倍。

静态随机访问存储器(SRAM)：由L1高速缓存和L2高速缓存用静态随机访问存储器的硬件技术实现的。处理能力更强大的有三级高速缓存：L1、2、3。

#### 存储设备形成层次结构

每个计算机系统中的存储设备都被组织成了**一个存储器层次结构**

![](https://img3.doubanio.com/view/photo/l/public/p2551888886.jpg)

#### 操作系统管理硬件

对于hello程序而言，**操作系统**为shell和hello程序与键盘、显示器、磁盘或者主存交互提供了服务。可以看作是程序和硬件之间插入的一层软件。

操作系统的两个基本功能：

* 防止硬件被失控的应用程序滥用

* 向应用程序提供简单一致的机制来控制复杂而又通常大相径庭的低级硬件设备

操作系统通过几个基本的抽象概念(进程、虚拟存储器和文件)来实现这两个功能

![](https://img3.doubanio.com/view/photo/l/public/p2551889960.jpg)

如图`1-11`所示，**`I/O`设备抽象为文件，虚拟存储器是对主存和磁盘`I/O`设备的抽象，进程是对处理器、主存和`I/O`设备的抽象**

#### 进程

**进程**是计算机科学中最重要和最成功的概念之一

**进程**是操作系统对一个正在运行的程序的一种抽象

**并发运行**，则是说一个进程的指令和另一个进程的指令交错执行。大多数系统中，需要运行的进程数是多于可以运行的CPU个数。传统系统一个时刻只能执行一个程序，而先进的多核处理器能同时执行多个程序。无论在单核还是多核系统中，一个CPU看上去都在并发执行多个进程，这是通过处理器在进程间切换来实现的。这种交错执行的机制称为**上下文切换**。**我们只考虑包含一个CPU的但处理器系统的情况**

上下文：操作系统保持跟踪进程运行所需的所有状态信息，特指这种状态(包括PC、寄存器文件的当前值，还有主存的内容)

**在任何一个时刻，单处理器系统都只能执行一个进程的代码**。图`1-12`展示hello程序运行场景的基本理念。

![](https://img3.doubanio.com/view/photo/l/public/p2551892776.jpg)

示例中有两个并发的进程：shell进程和hello进程。


#### 线程

通常认为一个进程只有单一的控制流，但是现代系统中，一个进程实际上可以由多个称为**线程**的执行单元组成，每个线程都运行在进程的上下文中，并共享同样的代码和全局数据。由于**网络服务器**对并行处理的需求，线程称为越来越重要的**编程模型**，因为多线程之间比多进程之间更容易共享数据，也因为线程一般比进程更高效。

#### 虚拟存储器

虚拟存储器是一个抽象的概念，它为每个进程提供一个假象，**独占主存**。每个进程看到都是一致的存储器，称为**虚拟地址空间**。如图`1-13`，地址从下往上增大。地址空间最上面的区域为操作系统的代码和数据保留的，地址空间底部存放用户进程定义的代码和数据。

![](https://img3.doubanio.com/view/photo/l/public/p2551893982.jpg)

进程所看到的虚拟地址空间由大量准确定义的区构成，从最低的地址开始介绍：

* 程序代码和数据：对于进程，代码是从同一固定地址开始，紧接着的是和C全局变量相对应的数据位置。代码和数据区是直接按照可执行目标文件的内容初始化的。

* 堆：代码和数据区后紧随着的是运行时堆。代码和数据区是进程一开始运行就规定了大小，当调用`malloc`和`free`这样的C标准库函数时，堆可以在运行时动态扩展和收缩

* 共享库：存放C标准库和数学库这样共享库的代码和数据的区域

* 栈：位于用户虚拟地址空间顶部的是用户栈，编译器用它来实现函数调用。和堆一样，也能动态扩展和收缩

* 内核虚拟存储器：内核总是驻留在内存中，是操作系统一部分。

虚拟存储器的基本思想是把一个进程虚拟存储器的内容存储在磁盘上，然后用主存作为磁盘的高速缓存。

#### 文件

文件就是**字节序列**。磁盘、键盘、显示器，甚至网络都可以视为文件。

#### 系统之间利用网络通信

![](https://img3.doubanio.com/view/photo/l/public/p2551896653.jpg)

随着Internet这样的全球网络的出现，将一台主机的信息复制到另一台主机已成为计算机系统最重要的用途之一。如，电子邮件、即时通信、这样的应用都是基于网络复制信息的功能。

### 重要主题

#### 并发与并行

并发：指一个同时具有多个活动的系统

并行：指的是用并发使一个系统运行得更快

线程级并发：

* 允许一个用户同时从事多个任务，如：在一个窗口中开启Web浏览器，另一个窗口中运行字处理器。

* 在以前，即使处理器必须在多个任务间切换，大多数实际的计算也都是由一个处理器完成的。这种配置称为**单处理器系统**。

![](https://img3.doubanio.com/view/photo/l/public/p2551909566.jpg)

* 当构建一个由单操作系统内核控制的多处理器组成的系统时，我们就得到了一个**多处理器系统**。随着发展，**多核处理器**和**超线程**的出现，这种系统才变的常见。图`1-16`列出这些处理器的分类和包含关系。

* 多核处理器将多个CPU(称为“核”)集成到一个集成电路芯片上。

* 多核处理器也就是一颗处理器有多个核心的处理器，比如双核、四核。多处理器是指在一个计算机系统内有多个处理器，互相协同工作。

* 图`1-17`描述的是i7处理器的组织结构，其中微处理器芯片有4个CPU核，每个核都有自己的L1、2高速缓存，但它们共享更高层次的高速缓存

`Intel Core i7`

![](https://img3.doubanio.com/view/photo/l/public/p2551906970.jpg)


* 超线程，有时称为**同时多线程**，是一项允许一个CPU执行多个控制流的技术。

指令级并行：

* 同时执行多条指令的属性称为**指令级并行**。

* 如果处理器可以达到比一个周期一条指令更快的执行速率，就称之为**超标量**

单指令、多数据并行

* 允许一条指令产生多个可以并行执行的操作，这种方式称为**单指令、多数据**，即`SIMD`并行。


#### 计算机系统中抽象的重要性

![](https://img3.doubanio.com/view/photo/l/public/p2551907971.jpg)




  




